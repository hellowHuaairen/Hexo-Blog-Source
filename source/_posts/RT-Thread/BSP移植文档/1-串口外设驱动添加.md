刚移植好的 BSP 默认只支持 UART1，接下来我们添加UART2/3 和 LPUART1 的支持。

![mark](http://mculover666.cn/image/20190827/0PrMy0Pdu7YL.png?imageslim)

# 添加UART2

##　打开 STM32CubeMX 工程

打开 BSP 的 STM32CubeMX 配置文件：

![mark](http://mculover666.cn/image/20190827/PAmcyQgMgnQj.png?imageslim)

## 按原理图配置 UART2，并生成代码

按图示顺序配置 UART2，并生成代码：

![mark](http://mculover666.cn/image/20190827/PH4EVsHvpaFp.png?imageslim)

## 修改 Kconfig 文件

打开 board 文件夹下的 Konfig 文件，拷贝 UART1 的配置项，并重命名为 UART2：

![mark](http://mculover666.cn/image/20190827/8fSFeh2qV14z.png?imageslim)

## 重新配置工程

经过上一步的修改，此时重新打开 ENV 工具，在 menuconfig 中就会出现添加的 UART2 的配置项：

![mark](http://mculover666.cn/image/20190827/3MEKnOOAG497.png?imageslim)

## 生成工程，检查驱动文件
保存退出 menuconfig 后，重新生成工程：

```bash
scons --target=mdk5
```
使用 ENV 重新生成工程并打开，检查原有驱动文件是否支持新添加的驱动（查看是否有新驱动的配置文件，中断函数，DMA配置和中断函数等等），如不支持，需参考现有驱动添加相关的代码。

![mark](http://mculover666.cn/image/20190827/lDWxF82Mnnvh.png?imageslim)

## 编译下载

检查完工程后，编译下载到开发板，程序会自动开始运行。输入 list_device 命令，可以看到 uart2 总线已经注册到内核，说明驱动已经添加成功。

![mark](http://mculover666.cn/image/20190827/MvYv3R8xEovW.png?imageslim)

# 添加UART3

按照上面同样的操作，添加UART3：

![mark](http://mculover666.cn/image/20190827/pv1XJEaWObs3.png?imageslim)

![mark](http://mculover666.cn/image/20190828/cKF9LLSgDgao.png?imageslim)

![mark](http://mculover666.cn/image/20190828/Nr3D8teamcRO.png?imageslim)

# 添加LPUART1

操作同上，不再赘述。

![mark](http://mculover666.cn/image/20190828/jVOA90iyzg7n.png?imageslim)

# 测试UART2/UART3/LPUART1驱动

>确保片上外设驱动 UART2/UART3/LPUART1 已开启！

打开menuconfig，进入`RT-Thread Kernel → Kernel Device Object`，将控制台串口改为`uart2`：

![mark](http://mculover666.cn/image/20190828/y22yzzfCIvOD.png?imageslim)

保存退出，重新生成工程，然后编译下载。

使用另外的USB转串口接在小熊派开发板的 uart2 上，复位开发板，即可看到控制台在 uart2 输出：

![mark](http://mculover666.cn/image/20190828/kNugp7h4S0Ck.png?imageslim)

同样，将控制台串口改到`uart3`测试，将 USB 转串口接在小熊派开发板的 uart3 上可看到控制台在 uart3 输出：

![mark](http://mculover666.cn/image/20190828/NoTX0PzCrb1N.png?imageslim)

同样，将控制台串口改到`lpuart1`测试，将 USB 转串口接在小熊派开发板的 lpuart1 上可看到控制台在 lpuart1 输出：

![mark](http://mculover666.cn/image/20190828/jI9gDFVhhimL.png?imageslim)

至此，小熊派开发板的串口驱动添加完毕。



