# 1. 添加SPI
## 1.1. 打开 STM32CubeMX 工程

打开 BSP 的 STM32CubeMX 配置文件：

![mark](http://mculover666.cn/image/20190827/PAmcyQgMgnQj.png?imageslim)

## 1.2. 配置 I2C 的引脚

依赖于 PIN 驱动，无需任何操作。

## 1.3. 修改 Kconfig 文件

打开 board 文件夹下的 Konfig 文件，添加 I2C4 的配置项：

    menuconfig BSP_USING_I2C    
        bool "Enable I2C (software simulation)"
        default n
        select RT_USING_I2C
        select RT_USING_I2C_BITOPS
        select RT_USING_PIN
        if BSP_USING_I2C
            config BSP_USING_I2C1
            bool "Enable I2C1 BUS (software simulation)"
            default n
            if BSP_USING_I2C1
                comment "Notice: PB6 --> 22; PB7 --> 23" 
                config BSP_I2C1_SCL_PIN
                    int "i2c1 scl pin number"
                    range 1 48
                    default 22
                config BSP_I2C1_SDA_PIN
                    int "I2C1 sda pin number"
                    range 1 48
                    default 23
            endif

            config BSP_USING_I2C3
            bool "Enable I2C3 BUS (software simulation)"
            default n
            if BSP_USING_I2C3
                comment "Notice: PA7 --> 7; PB4 --> 20" 
                config BSP_I2C3_SCL_PIN
                    int "i2c3 scl pin number"
                    range 1 49
                    default 7
                config BSP_I2C3_SDA_PIN
                    int "I2C3 sda pin number"
                    range 1 48
                    default 20
            endif
        endif

## 1.4. 重新配置工程

经过上一步的修改，此时重新打开 ENV 工具，在 menuconfig 中就会出现添加的 I2C1/3 的配置项：

![mark](http://mculover666.cn/image/20190828/YbD5CLq0GLe0.png?imageslim)

## 1.5. 生成工程，检查驱动文件

使用 ENV 重新生成工程并打开，检查原有驱动文件是否支持新添加的驱动（查看是否有新驱动的配置文件，中断函数，DMA配置和中断函数等等），如不支持，需参考现有驱动添加相关的代码：

![mark](http://mculover666.cn/image/20190828/3LDLzQxj29p0.png?imageslim)

## 1.6. 编译下载

检查完工程后，编译下载到开发板，程序会自动开始运行。输入 list_device 命令，可以看到 spi1 总线已经注册到内核，说明驱动已经添加成功：

![mark](http://mculover666.cn/image/20190828/dQFKE7LKGzei.png?imageslim)




